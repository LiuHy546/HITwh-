{% extends "base.html" %}

{% block title %}{{ activity.title }} - 校园活动管理系统{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h2 class="card-title">{{ activity.title }}</h2>
                    {% if activity.poster_url %}
                    <div class="text-center mb-4">
                        <img src="{{ activity.poster_url }}" alt="活动海报" class="img-fluid rounded" style="max-height: 400px;">
                    </div>
                    {% endif %}
                    <div class="text-muted mb-3">
                        <p>
                            <i class="bi bi-geo-alt"></i> 地点：{{ activity.venue.name }}<br>
                            <i class="bi bi-calendar"></i> 时间：{{ activity.start_time_cst.strftime('%Y-%m-%d %H:%M') if activity.start_time_cst else 'N/A' }} 至 {{ activity.end_time_cst.strftime('%Y-%m-%d %H:%M') if activity.end_time_cst else 'N/A' }}<br>
                            <i class="bi bi-people"></i> 参与人数：{{ activity.current_participants }}/{{ activity.max_participants }}<br>
                            <i class="bi bi-person"></i> 组织者：{{ activity.organizer.username }}<br>
                            <i class="bi bi-tags"></i> 标签：
                            {% for tag in activity.tags.split(',') %}
                            <span class="badge bg-secondary">{{ tag.strip() }}</span>
                            {% endfor %}
                        </p>
                    </div>
                    <div class="card-text">
                        <h5>活动详情</h5>
                        <p>{{ activity.description }}</p>
                    </div>
                    {% if current_user.is_authenticated %}
                        {% if is_joined %}
                            <button type="button" class="btn btn-outline-secondary mt-3" data-bs-toggle="modal" data-bs-target="#quitModal">
                                退出活动
                            </button>
                        {% elif activity.current_status == '报名中' %}
                            {% if activity.current_participants < activity.max_participants %}
                                <form method="POST" action="{{ url_for('user.join_activity', activity_id=activity.id) }}" class="mt-3">
                                    <button type="submit" class="btn btn-primary">参加活动</button>
                                </form>
                            {% else %}
                                <div class="alert-warning mt-3 p-3 bg-primary-subtle rounded text-dark">
                                    活动已满
                                </div>
                            {% endif %}
                        {% elif activity.current_status == '进行中' %}
                            <div class="alert-info mt-3 p-3 bg-primary-subtle rounded text-dark">
                                活动进行中
                            </div>
                        {% elif activity.current_status == '已结束' %}
                             <div class="alert-secondary mt-3 p-3 bg-primary-subtle rounded text-dark">
                                活动已结束
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="mt-3 p-3 bg-primary-subtle rounded text-dark" style="background-color:skyblue;">
                            请<a href="{{ url_for('auth.login') }}" class="text-primary"><strong>登录</strong></a>后参加活动
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title">评论区</h4>
                    {% if current_user.is_authenticated %}
                    <form method="POST" action="{{ url_for('user.add_comment', activity_id=activity.id) }}" class="mb-4">
                        <div class="mb-3">
                            <textarea name="content" class="form-control" rows="3" placeholder="写下你的评论..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">发表评论</button>
                    </form>
                    {% else %}
                    <div class="mb-4 p-3 bg-primary-subtle rounded text-dark" style="background-color:skyblue;">
                        请<a href="{{ url_for('auth.login') }}" class="text-primary"><strong>登录</strong></a>后发表评论
                    </div>
                    {% endif %}

                    <div class="comments">
                        {% for comment in comments %}
                        <div class="comment mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <strong>{{ comment.user.username }}</strong>
                                    <small class="text-muted ms-2">{{ comment.display_time }}</small>
                                </div>
                            </div>
                            <p class="mb-0">{{ comment.content }}</p>
                        </div>
                        {% else %}
                        <div class="text-muted text-center py-3">
                            暂无评论
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">活动信息</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            状态
                            <span class="badge bg-{{ 'success' if activity.current_status == '进行中' else ('info' if activity.current_status == '报名中' else 'secondary') }}">
                                {{ activity.current_status }}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            活动类型
                            <span class="badge bg-info">{{ activity.activity_type.name if activity.activity_type else '未指定' }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            剩余名额
                            <span class="badge bg-primary">{{ activity.max_participants - activity.current_participants }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            开始时间
                            <span class="badge bg-info">{{ activity.start_time_cst.strftime('%Y-%m-%d %H:%M') if activity.start_time_cst else 'N/A' }} </span>
                        </li>

                    </ul>
                </div>
            </div>

            {% if current_user.is_authenticated and activity.organizer_id == current_user.id %}
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">活动管理</h5>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('user.edit_activity', activity_id=activity.id) }}" class="btn btn-outline-primary">编辑活动</a>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            删除活动
                        </button>
                    </div>
                </div>
            </div>
            {% if is_exportable %}
            <div class="d-grid mt-2">
                <a href="{{ url_for('public.export_activity', activity_id=activity.id) }}" class="btn btn-outline-success">导出活动数据</a>
            </div>
            {% endif %}
            <!-- 删除确认模态框 -->
            <div class="modal fade" id="deleteModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">确认删除</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            确定要删除这个活动吗？此操作不可恢复。
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <form method="POST" action="{{ url_for('user.delete_activity', activity_id=activity.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-danger">确认删除</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 退出活动确认模态框 -->
<div class="modal fade" id="quitModal" tabindex="-1" aria-labelledby="quitModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quitModalLabel">确认退出</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                确定要退出这个活动吗？此操作不可恢复。
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form method="POST" action="{{ url_for('user.quit_activity', activity_id=activity.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-outline-secondary">确认退出</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %} 