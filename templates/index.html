{% extends "base.html" %}

{% block title %}首页 - 校园活动社交平台{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4 align-items-center">
        <h2 class="mb-0">活动列表</h2>
        <div class="d-flex justify-content-between align-items-center flex-wrap" style="width:100%;">
            <div style="min-width: 520px; max-width: 600px; width: 100%;">
                <div class="p-3 bg-light rounded shadow-sm">
                    <form class="row g-2 align-items-center mb-0 flex-wrap" method="GET" action="{{ url_for('public.index') }}" style="gap: 8px 0;">
                        <div class="col-6 col-lg-4">
                            <input class="form-control" type="search" name="search" placeholder="搜索活动/关键词" value="{{ search_query }}">
                        </div>
                        <div class="col-6 col-lg-4">
                            <select class="form-select" name="activity_type_id">
                                <option value="">类型(全部)</option>
                                {% for type in activity_types %}
                                <option value="{{ type.id }}" {% if activity_type_id == type.id %}selected{% endif %}>{{ type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6 col-lg-4">
                            <select class="form-select" name="status">
                                <option value="">状态(全部)</option>
                                <option value="upcoming" {% if status_filter == 'upcoming' %}selected{% endif %}>报名中</option>
                                <option value="ongoing" {% if status_filter == 'ongoing' %}selected{% endif %}>进行中</option>
                                <option value="ended" {% if status_filter == 'ended' %}selected{% endif %}>已结束</option>
                            </select>
                        </div>
                        <div class="col-6 col-lg-4">
                            <select class="form-select" name="venue_id">
                                <option value="">场地(全部)</option>
                                {% for venue in venues %}
                                <option value="{{ venue.id }}" {% if venue_id == venue.id %}selected{% endif %}>{{ venue.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6 col-lg-4">
                            <input type="date" class="form-control" name="start_date" value="{{ start_date }}" placeholder="开始日期">
                        </div>
                        <div class="col-6 col-lg-4">
                            <input type="date" class="form-control" name="end_date" value="{{ end_date }}" placeholder="结束日期">
                        </div>
                        <div class="col-12 d-flex align-items-center justify-content-end">
                            <button type="submit" class="btn btn-primary px-4">筛选</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content-area"> {# Main content area wrapper #}
        <div class="row mb-4">
            <div class="col-12">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('public.index', search=search_query, hot=hot, status=status_filter) }}" class="btn btn-outline-primary {% if activity_type_id is none and not recommend_mode %}active{% endif %}">全部</a>
                    <a href="{{ url_for('public.index', recommend=1) }}" class="btn btn-outline-primary {% if recommend_mode %}active{% endif %}">推荐</a>
                    {% for type in activity_types %}
                    <a href="{{ url_for('public.index', activity_type_id=type.id, search=search_query, hot=hot, status=status_filter) }}" class="btn btn-outline-primary {% if activity_type_id == type.id %}active{% endif %}">{{ type.name }}</a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('public.index', search=search_query, hot=hot, activity_type_id=activity_type_id) }}" class="btn btn-outline-primary {% if status_filter == '' %}active{% endif %}">全部状态</a>
                    <a href="{{ url_for('public.index', status='upcoming', search=search_query, hot=hot, activity_type_id=activity_type_id) }}" class="btn btn-outline-primary {% if status_filter == 'upcoming' %}active{% endif %}">报名中</a>
                    <a href="{{ url_for('public.index', status='ongoing', search=search_query, hot=hot, activity_type_id=activity_type_id) }}" class="btn btn-outline-primary {% if status_filter == 'ongoing' %}active{% endif %}">进行中</a>
                    <a href="{{ url_for('public.index', status='ended', search=search_query, hot=hot, activity_type_id=activity_type_id) }}" class="btn btn-outline-primary {% if status_filter == 'ended' %}active{% endif %}">已结束</a>
                </div>
            </div>
        </div>

        {# Main activity list #}
        <div class="row row-cols-1 g-4">
            {% if recommend_mode %}
                {% for activity in activities %}
                <div class="col">
                    <div class="feed-item" style="border: 1px solid #ccc; border-radius: 8px; padding: 10px;">
                        <div class="feed-item-content">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="feed-item-title mb-0"><a href="{{ url_for('public.activity_detail', activity_id=activity.id) }}" class="text-decoration-none">{{ activity.title }}</a></h5>
                                {% if activity.activity_type %}
                                <span class="badge border border-secondary text-secondary bg-white" style="font-weight: normal;">{{ activity.activity_type.name }}</span>
                                {% endif %}
                            </div>
                            <p class="feed-item-description">{{ activity.description[:70] }}...</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="feed-item-info d-flex align-items-center mt-2">
                                    <span class="me-3 d-flex align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#17a2b8" class="bi bi-people-fill me-1" viewBox="0 0 16 16">
                                            <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm-9.985c0 1 0 1 0 1a1.5 1.5 0 0 0-.015-.136l-.318-1.497a1.65 1.65 0 0 0-.306-.933A3.5 3.5 0 0 1 0 8c0-.642.508-1.219 1.202-1.462A.9.9 0 0 0 1 6.906V6.5c0-.416.154-.82.4-.116a.95.95 0 0 0 .96-.243C2.574 5.011 3 4.686 3 4V2c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2c0 .686-.426 1.014-.54 1.141a.95.95 0 0 0 .96.243A.95.95 0 0 0 14 6.5v.406c0 .078-.017.15-.04.22-.136.318-.683 1.497-1 2a1.5 1.5 0 0 0-.015.136c0 0 0 0 0 1H1.015ZM11 4a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z"/>
                                        </svg>
                                        {{ activity.current_participants }}/{{ activity.max_participants }}
                                    </span>
                                    <span class="me-3 d-flex align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#8590a6" class="bi bi-chat-dots-fill me-1" viewBox="0 0 16 16">
                                            <path d="M16 8c0 3.866-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.584.296-1.186.83-1.844 1.742A10.12 10.12 0 0 1 4.431 15H1c-.269 0-.5-.221-.5-.493V8a8.001 8.001 0 0 1 15-7.798V8ZM5 8a1 1 0 1 0-2 0 1 1 0 0 0 2 0Zm4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0Zm3 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0Z"/>
                                        </svg>
                                        {{ activity.comments|length if activity.comments is defined else 0 }}
                                    </span>
                                    <span class="like-button me-3 d-flex align-items-center" style="cursor: pointer;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#8590a6" class="bi bi-heart-fill me-1" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.736 8 15-7.534 4.736 3.562-3.248 8 1.314Z"/>
                                        </svg>
                                        <span class="likes-count">{{ activity.likes_count }}</span>
                                    </span>
                                </div>
                                <div class="feed-item-meta mt-2 text-muted small d-flex align-items-center">
                                    {% if activity.current_status == '报名中' and activity.current_participants >= activity.max_participants %}
                                        <span class="badge bg-secondary me-2">活动已满</span>
                                    {% elif activity.current_status == '报名中' %}
                                        {% if current_user.is_authenticated and activity.is_joined %}
                                            <span class="badge bg-success me-2">已报名</span>
                                        {% else %}
                                            <span class="badge bg-info me-2">{{ activity.current_status }}</span>
                                        {% endif %}
                                    {% elif activity.current_status == '进行中' %}
                                        <span class="badge bg-success me-2">{{ activity.current_status }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary me-2">{{ activity.current_status }}</span>
                                    {% endif %}
                                    {% if activity.tags %}
                                        {% for tag in activity.tags.split(',') %}
                                        {% if tag.strip() %}
                                        <span class="badge bg-light text-dark ms-1">{{ tag.strip() }}</span>
                                        {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if activity.poster_url %}
                        <div class="feed-item-poster">
                            <img src="{{ activity.poster_url }}" alt="{{ activity.title }} 海报">
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                {% for activity in activities.items %}
                <div class="col">
                    <div class="feed-item" style="border: 1px solid #ccc; border-radius: 8px; padding: 10px;">
                        <div class="feed-item-content">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="feed-item-title mb-0"><a href="{{ url_for('public.activity_detail', activity_id=activity.id) }}" class="text-decoration-none">{{ activity.title }}</a></h5>
                                {% if activity.activity_type %}
                                <span class="badge border border-secondary text-secondary bg-white" style="font-weight: normal;">{{ activity.activity_type.name }}</span>
                                {% endif %}
                            </div>
                            <p class="feed-item-description">{{ activity.description[:70] }}...</p>
                            <div class="d-flex justify-content-between align-items-center">
                                {# Info line with participants, comments, and likes #}
                                <div class="feed-item-info d-flex align-items-center mt-2">
                                    <span class="me-3 d-flex align-items-center">
                                        {# Colorful users icon #}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#17a2b8" class="bi bi-people-fill me-1" viewBox="0 0 16 16">
                                            <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm-9.985c0 1 0 1 0 1a1.5 1.5 0 0 0-.015-.136l-.318-1.497a1.65 1.65 0 0 0-.306-.933A3.5 3.5 0 0 1 0 8c0-.642.508-1.219 1.202-1.462A.9.9 0 0 0 1 6.906V6.5c0-.416.154-.82.4-.116a.95.95 0 0 0 .96-.243C2.574 5.011 3 4.686 3 4V2c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2c0 .686-.426 1.014-.54 1.141a.95.95 0 0 0 .96.243A.95.95 0 0 0 14 6.5v.406c0 .078-.017.15-.04.22-.136.318-.683 1.497-1 2a1.5 1.5 0 0 0-.015.136c0 0 0 0 0 1H1.015ZM11 4a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z"/>
                                        </svg>
                                        {{ activity.current_participants }}/{{ activity.max_participants }}
                                    </span>
                                    <span class="me-3 d-flex align-items-center">
                                        {# Colorful comments icon #}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#8590a6" class="bi bi-chat-dots-fill me-1" viewBox="0 0 16 16">
                                            <path d="M16 8c0 3.866-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.584.296-1.186.83-1.844 1.742A10.12 10.12 0 0 1 4.431 15H1c-.269 0-.5-.221-.5-.493V8a8.001 8.001 0 0 1 15-7.798V8ZM5 8a1 1 0 1 0-2 0 1 1 0 0 0 2 0Zm4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0Zm3 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0Z"/>
                                        </svg>
                                        {{ activity.comments|length }}
                                    </span>
                                    {# Add like button and count #}
                                    <span class="like-button{% if activity.is_liked %} liked{% endif %} me-3 d-flex align-items-center" data-activity-id="{{ activity.id }}" style="cursor: pointer;">
                                        {# Colorful heart icon #}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="{% if activity.is_liked %}#dc3545{% else %}#8590a6{% endif %}" class="bi bi-heart-fill me-1" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.736 8 15-7.534 4.736 3.562-3.248 8 1.314Z"/>
                                        </svg>
                                        <span class="likes-count">{{ activity.likes_count }}</span>
                                    </span>
                                </div> {# Close feed-item-info #}
                                
                                {# Add activity status and tags here in a new line within feed-item-content #}
                                <div class="feed-item-meta mt-2 text-muted small d-flex align-items-center">
                                    {# Activity status badge #}
                                    {% if activity.current_status == '报名中' and activity.current_participants >= activity.max_participants %}
                                        <span class="badge bg-secondary me-2">活动已满</span>
                                    {% elif activity.current_status == '报名中' %}
                                        {% if current_user.is_authenticated and activity.is_joined %}
                                            <span class="badge bg-success me-2">已报名</span>
                                        {% else %}
                                            <span class="badge bg-info me-2">{{ activity.current_status }}</span>
                                        {% endif %}
                                    {% elif activity.current_status == '进行中' %}
                                        <span class="badge bg-success me-2">{{ activity.current_status }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary me-2">{{ activity.current_status }}</span>
                                    {% endif %}
        
                                    {# Activity tags #}
                                    {% if activity.tags %}
                                        {% for tag in activity.tags.split(',') %}
                                        {% if tag.strip() %}
                                        <span class="badge bg-light text-dark ms-1">{{ tag.strip() }}</span>
                                        {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div> {# Close feed-item-meta #}
                            </div>
                        </div> {# Close feed-item-content #}
                        
                        {# feed-item-poster remains a sibling of feed-item-content #}
                        {% if activity.poster_url %}
                        <div class="feed-item-poster">
                            <img src="{{ activity.poster_url }}" alt="{{ activity.title }} 海报">
                        </div> {# Close feed-item-poster #}
                        {% endif %}
                    </div> {# Close feed-item #}
                </div>
                {% else %}
                <div class="col-12">
                    <div class="alert-info p-3 mb-4">
                        暂无活动
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>

        {% if not recommend_mode and activities.pages > 1 %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not activities.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('public.index', page=activities.prev_num, search=search_query, activity_type_id=activity_type_id, hot=hot) }}">上一页</a>
                </li>
                {% for page_num in activities.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                    {% if page_num %}
                        {% if page_num == activities.page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('public.index', page=page_num, search=search_query, activity_type_id=activity_type_id, hot=hot) }}">{{ page_num }}</a>
                        </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if activities.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('public.index', page=activities.next_num, search=search_query, activity_type_id=activity_type_id, hot=hot) }}">下一页</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    </div> {# Main content area wrapper ends #}

    {# Hot activities sidebar #}
    <div class="hot-activities-sidebar" style="margin-right: 200px; margin-top: 70px;"> 
        <div class="card shadow-sm">
            <div class="card-header">热门活动推荐</div>
            <div class="card-body">
                {% if hot_activities %}
                    <ul class="list-group list-group-flush">
                        {% for item in hot_activities %}
                            <li class="list-group-item">
                                <a href="{{ url_for('public.activity_detail', activity_id=item.activity.id) }}">{{ item.activity.title }}</a>
                                <p class="card-text text-muted small mb-1">
                                    <i class="bi bi-people"></i> 参与: {{ item.activity.current_participants }} / {{ item.activity.max_participants }}
                                    <span class="ms-2">({{ (item.participation_ratio * 100) | round(1) }}%)</span><br>
                                    <i class="bi bi-chat-dots"></i> 评论: {{ item.comments }}<br>
                                    <i class="bi bi-hand-thumbs-up"></i> 点赞: {{ item.likes }}
                                </p>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="card-text">暂无热门活动</p>
                {% endif %}
            </div>
        </div>
    </div> {# Hot activities sidebar ends #}

</div> {# Close the container div #}
{% endblock %} 

